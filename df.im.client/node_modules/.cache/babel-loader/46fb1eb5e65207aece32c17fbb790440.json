{"ast":null,"code":"import _regeneratorRuntime from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import{createAsyncThunk,createSlice,configureStore,combineReducers}from\"@reduxjs/toolkit\";import{getUserList}from\"./imApi\";var initialState={showMain:false,showSetting:false,showChat:false,showHelp:false,size:{left:0,top:0,right:window.innerWidth-20-40,bottom:window.innerHeight-20-40},status:\"idle\",zIndex:9999,users:[],currentChatUser:null,// 添加当前聊天用户信息\nonlineUsers:{},// 在线用户状态\nunreadMessages:{},// 未读消息计数\nincomingCall:null// 收到的视频邀请\n};export var getUsers=createAsyncThunk(\"imReducer/getUsers\",/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(params,_ref){var dispatch,urlParams,uid,response;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:dispatch=_ref.dispatch;urlParams=new URLSearchParams(window.location.search);uid=urlParams.get(\"uId\");console.log(\"Getting users for uid:\",uid);_context.next=6;return getUserList(parseInt(uid));case 6:response=_context.sent;return _context.abrupt(\"return\",response.data);case 8:case\"end\":return _context.stop();}}},_callee);}));return function(_x,_x2){return _ref2.apply(this,arguments);};}());var imSlice=createSlice({name:\"imReducer\",// 生成的action名中会包含此前缀\ninitialState:initialState,reducers:{togglerMain:function togglerMain(state){// action name : 'imReducer/togglerMain'\nstate.showMain=!state.showMain;},resize:function resize(state){state.size.right=window.innerWidth-20;state.size.bottom=window.innerHeight-20;},togglerSetting:function togglerSetting(state){state.showSetting=!state.showSetting;},togglerChat:function togglerChat(state,action){if(action.payload){// 如果提供了用户信息，说明是要打开或切换聊天\nstate.showChat=true;state.currentChatUser=action.payload;}else{// 如果没有提供用户信息，说明是要关闭聊天窗口\nstate.showChat=false;state.currentChatUser=null;}},togglerHelp:function togglerHelp(state){state.showHelp=!state.showHelp;},incrementzIndex:function incrementzIndex(state){state.zIndex+=1;},updateUserStatus:function updateUserStatus(state,action){state.onlineUsers[action.payload.uid]=action.payload.online;},addUnreadMessage:function addUnreadMessage(state,action){var fromUid=action.payload.fromUid;if(!state.unreadMessages[fromUid]){state.unreadMessages[fromUid]=0;}state.unreadMessages[fromUid]++;},clearUnreadMessages:function clearUnreadMessages(state,action){var uid=action.payload.uid;state.unreadMessages[uid]=0;},setIncomingCall:function setIncomingCall(state,action){console.log(\"Setting incoming call:\",action.payload);state.incomingCall=action.payload;}},extraReducers:function extraReducers(builder){builder.addCase(getUsers.pending,function(state){state.status=\"loading\";}).addCase(getUsers.fulfilled,function(state,action){state.status=\"successful\";state.users=Array.isArray(action.payload)?action.payload:[];}).addCase(getUsers.rejected,function(state,action){state.status=\"failed\";console.error(\"Failed to get users:\",action.error.message);state.users=[];// 确保users始终是数组\n});}});// imSlice actions ************************************************\nvar _imSlice$actions=imSlice.actions,togglerMain=_imSlice$actions.togglerMain,resize=_imSlice$actions.resize,togglerSetting=_imSlice$actions.togglerSetting,togglerChat=_imSlice$actions.togglerChat,togglerHelp=_imSlice$actions.togglerHelp,incrementzIndex=_imSlice$actions.incrementzIndex,updateUserStatus=_imSlice$actions.updateUserStatus,addUnreadMessage=_imSlice$actions.addUnreadMessage,clearUnreadMessages=_imSlice$actions.clearUnreadMessages,setIncomingCall=_imSlice$actions.setIncomingCall;// imReducer states ************************************************\nexport{togglerMain,resize,togglerSetting,togglerChat,togglerHelp,incrementzIndex,updateUserStatus,addUnreadMessage,clearUnreadMessages,setIncomingCall};export var showMain=function showMain(state){return state.imReducer.showMain;};export var showSetting=function showSetting(state){return state.imReducer.showSetting;};export var showChat=function showChat(state){return state.imReducer.showChat;};export var showHelp=function showHelp(state){return state.imReducer.showHelp;};export var zIndex=function zIndex(state){return state.imReducer.zIndex;};// imStore states ************************************************\nexport var imStore=configureStore({reducer:{imReducer:imSlice.reducer}});// imStore.subscribe(() => console.log(imStore.getState()));","map":{"version":3,"names":["createAsyncThunk","createSlice","configureStore","combineReducers","getUserList","initialState","showMain","showSetting","showChat","showHelp","size","left","top","right","window","innerWidth","bottom","innerHeight","status","zIndex","users","currentChatUser","onlineUsers","unreadMessages","incomingCall","getUsers","params","dispatch","urlParams","URLSearchParams","location","search","uid","get","console","log","parseInt","response","data","imSlice","name","reducers","togglerMain","state","resize","togglerSetting","togglerChat","action","payload","togglerHelp","incrementzIndex","updateUserStatus","online","addUnreadMessage","fromUid","clearUnreadMessages","setIncomingCall","extraReducers","builder","addCase","pending","fulfilled","Array","isArray","rejected","error","message","actions","imReducer","imStore","reducer"],"sources":["/Users/feng/Work/Project/df/df.im/df.im.client/src/im/imStore.js"],"sourcesContent":["import {\n  createAsyncThunk,\n  createSlice,\n  configureStore,\n  combineReducers,\n} from \"@reduxjs/toolkit\";\nimport { getUserList } from \"./imApi\";\n\nconst initialState = {\n  showMain: false,\n  showSetting: false,\n  showChat: false,\n  showHelp: false,\n  size: {\n    left: 0,\n    top: 0,\n    right: window.innerWidth - 20 - 40,\n    bottom: window.innerHeight - 20 - 40,\n  },\n  status: \"idle\",\n  zIndex: 9999,\n  users: [],\n  currentChatUser: null, // 添加当前聊天用户信息\n  onlineUsers: {}, // 在线用户状态\n  unreadMessages: {}, // 未读消息计数\n  incomingCall: null, // 收到的视频邀请\n};\n\nexport const getUsers = createAsyncThunk(\n  \"imReducer/getUsers\",\n  async (params, { dispatch }) => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const uid = urlParams.get(\"uId\");\n    console.log(\"Getting users for uid:\", uid);\n    const response = await getUserList(parseInt(uid));\n    return response.data;\n  }\n);\n\nconst imSlice = createSlice({\n  name: \"imReducer\", // 生成的action名中会包含此前缀\n  initialState,\n  reducers: {\n    togglerMain: (state) => {\n      // action name : 'imReducer/togglerMain'\n      state.showMain = !state.showMain;\n    },\n    resize: (state) => {\n      state.size.right = window.innerWidth - 20;\n      state.size.bottom = window.innerHeight - 20;\n    },\n    togglerSetting: (state) => {\n      state.showSetting = !state.showSetting;\n    },\n    togglerChat: (state, action) => {\n      if (action.payload) {\n        // 如果提供了用户信息，说明是要打开或切换聊天\n        state.showChat = true;\n        state.currentChatUser = action.payload;\n      } else {\n        // 如果没有提供用户信息，说明是要关闭聊天窗口\n        state.showChat = false;\n        state.currentChatUser = null;\n      }\n    },\n    togglerHelp: (state) => {\n      state.showHelp = !state.showHelp;\n    },\n    incrementzIndex: (state) => {\n      state.zIndex += 1;\n    },\n    updateUserStatus: (state, action) => {\n      state.onlineUsers[action.payload.uid] = action.payload.online;\n    },\n    addUnreadMessage: (state, action) => {\n      const { fromUid } = action.payload;\n      if (!state.unreadMessages[fromUid]) {\n        state.unreadMessages[fromUid] = 0;\n      }\n      state.unreadMessages[fromUid]++;\n    },\n    clearUnreadMessages: (state, action) => {\n      const { uid } = action.payload;\n      state.unreadMessages[uid] = 0;\n    },\n    setIncomingCall: (state, action) => {\n      console.log(\"Setting incoming call:\", action.payload);\n      state.incomingCall = action.payload;\n    },\n  },\n  extraReducers: (builder) => {\n    builder\n      .addCase(getUsers.pending, (state) => {\n        state.status = \"loading\";\n      })\n      .addCase(getUsers.fulfilled, (state, action) => {\n        state.status = \"successful\";\n        state.users = Array.isArray(action.payload) ? action.payload : [];\n      })\n      .addCase(getUsers.rejected, (state, action) => {\n        state.status = \"failed\";\n        console.error(\"Failed to get users:\", action.error.message);\n        state.users = []; // 确保users始终是数组\n      });\n  },\n});\n\n// imSlice actions ************************************************\nexport const {\n  togglerMain,\n  resize,\n  togglerSetting,\n  togglerChat,\n  togglerHelp,\n  incrementzIndex,\n  updateUserStatus,\n  addUnreadMessage,\n  clearUnreadMessages,\n  setIncomingCall,\n} = imSlice.actions;\n\n// imReducer states ************************************************\nexport const showMain = (state) => state.imReducer.showMain;\nexport const showSetting = (state) => state.imReducer.showSetting;\nexport const showChat = (state) => state.imReducer.showChat;\nexport const showHelp = (state) => state.imReducer.showHelp;\nexport const zIndex = (state) => state.imReducer.zIndex;\n\n// imStore states ************************************************\nexport const imStore = configureStore({\n  reducer: {\n    imReducer: imSlice.reducer,\n  },\n});\n\n// imStore.subscribe(() => console.log(imStore.getState()));\n"],"mappings":"wRAAA,OACEA,gBAAgB,CAChBC,WAAW,CACXC,cAAc,CACdC,eAAe,KACV,kBAAkB,CACzB,OAASC,WAAW,KAAQ,SAAS,CAErC,GAAMC,aAAY,CAAG,CACnBC,QAAQ,CAAE,KAAK,CACfC,WAAW,CAAE,KAAK,CAClBC,QAAQ,CAAE,KAAK,CACfC,QAAQ,CAAE,KAAK,CACfC,IAAI,CAAE,CACJC,IAAI,CAAE,CAAC,CACPC,GAAG,CAAE,CAAC,CACNC,KAAK,CAAEC,MAAM,CAACC,UAAU,CAAG,EAAE,CAAG,EAAE,CAClCC,MAAM,CAAEF,MAAM,CAACG,WAAW,CAAG,EAAE,CAAG,EACpC,CAAC,CACDC,MAAM,CAAE,MAAM,CACdC,MAAM,CAAE,IAAI,CACZC,KAAK,CAAE,EAAE,CACTC,eAAe,CAAE,IAAI,CAAE;AACvBC,WAAW,CAAE,CAAC,CAAC,CAAE;AACjBC,cAAc,CAAE,CAAC,CAAC,CAAE;AACpBC,YAAY,CAAE,IAAM;AACtB,CAAC,CAED,MAAO,IAAMC,SAAQ,CAAGzB,gBAAgB,CACtC,oBAAoB,6FACpB,iBAAO0B,MAAM,6JAAIC,QAAQ,MAARA,QAAQ,CACjBC,SAAS,CAAG,GAAIC,gBAAe,CAACf,MAAM,CAACgB,QAAQ,CAACC,MAAM,CAAC,CACvDC,GAAG,CAAGJ,SAAS,CAACK,GAAG,CAAC,KAAK,CAAC,CAChCC,OAAO,CAACC,GAAG,CAAC,wBAAwB,CAAEH,GAAG,CAAC,CAAC,sBACpB5B,YAAW,CAACgC,QAAQ,CAACJ,GAAG,CAAC,CAAC,QAA3CK,QAAQ,+CACPA,QAAQ,CAACC,IAAI,wDACrB,oEACF,CAED,GAAMC,QAAO,CAAGtC,WAAW,CAAC,CAC1BuC,IAAI,CAAE,WAAW,CAAE;AACnBnC,YAAY,CAAZA,YAAY,CACZoC,QAAQ,CAAE,CACRC,WAAW,CAAE,qBAACC,KAAK,CAAK,CACtB;AACAA,KAAK,CAACrC,QAAQ,CAAG,CAACqC,KAAK,CAACrC,QAAQ,CAClC,CAAC,CACDsC,MAAM,CAAE,gBAACD,KAAK,CAAK,CACjBA,KAAK,CAACjC,IAAI,CAACG,KAAK,CAAGC,MAAM,CAACC,UAAU,CAAG,EAAE,CACzC4B,KAAK,CAACjC,IAAI,CAACM,MAAM,CAAGF,MAAM,CAACG,WAAW,CAAG,EAAE,CAC7C,CAAC,CACD4B,cAAc,CAAE,wBAACF,KAAK,CAAK,CACzBA,KAAK,CAACpC,WAAW,CAAG,CAACoC,KAAK,CAACpC,WAAW,CACxC,CAAC,CACDuC,WAAW,CAAE,qBAACH,KAAK,CAAEI,MAAM,CAAK,CAC9B,GAAIA,MAAM,CAACC,OAAO,CAAE,CAClB;AACAL,KAAK,CAACnC,QAAQ,CAAG,IAAI,CACrBmC,KAAK,CAACtB,eAAe,CAAG0B,MAAM,CAACC,OAAO,CACxC,CAAC,IAAM,CACL;AACAL,KAAK,CAACnC,QAAQ,CAAG,KAAK,CACtBmC,KAAK,CAACtB,eAAe,CAAG,IAAI,CAC9B,CACF,CAAC,CACD4B,WAAW,CAAE,qBAACN,KAAK,CAAK,CACtBA,KAAK,CAAClC,QAAQ,CAAG,CAACkC,KAAK,CAAClC,QAAQ,CAClC,CAAC,CACDyC,eAAe,CAAE,yBAACP,KAAK,CAAK,CAC1BA,KAAK,CAACxB,MAAM,EAAI,CAAC,CACnB,CAAC,CACDgC,gBAAgB,CAAE,0BAACR,KAAK,CAAEI,MAAM,CAAK,CACnCJ,KAAK,CAACrB,WAAW,CAACyB,MAAM,CAACC,OAAO,CAAChB,GAAG,CAAC,CAAGe,MAAM,CAACC,OAAO,CAACI,MAAM,CAC/D,CAAC,CACDC,gBAAgB,CAAE,0BAACV,KAAK,CAAEI,MAAM,CAAK,CACnC,GAAQO,QAAO,CAAKP,MAAM,CAACC,OAAO,CAA1BM,OAAO,CACf,GAAI,CAACX,KAAK,CAACpB,cAAc,CAAC+B,OAAO,CAAC,CAAE,CAClCX,KAAK,CAACpB,cAAc,CAAC+B,OAAO,CAAC,CAAG,CAAC,CACnC,CACAX,KAAK,CAACpB,cAAc,CAAC+B,OAAO,CAAC,EAAE,CACjC,CAAC,CACDC,mBAAmB,CAAE,6BAACZ,KAAK,CAAEI,MAAM,CAAK,CACtC,GAAQf,IAAG,CAAKe,MAAM,CAACC,OAAO,CAAtBhB,GAAG,CACXW,KAAK,CAACpB,cAAc,CAACS,GAAG,CAAC,CAAG,CAAC,CAC/B,CAAC,CACDwB,eAAe,CAAE,yBAACb,KAAK,CAAEI,MAAM,CAAK,CAClCb,OAAO,CAACC,GAAG,CAAC,wBAAwB,CAAEY,MAAM,CAACC,OAAO,CAAC,CACrDL,KAAK,CAACnB,YAAY,CAAGuB,MAAM,CAACC,OAAO,CACrC,CACF,CAAC,CACDS,aAAa,CAAE,uBAACC,OAAO,CAAK,CAC1BA,OAAO,CACJC,OAAO,CAAClC,QAAQ,CAACmC,OAAO,CAAE,SAACjB,KAAK,CAAK,CACpCA,KAAK,CAACzB,MAAM,CAAG,SAAS,CAC1B,CAAC,CAAC,CACDyC,OAAO,CAAClC,QAAQ,CAACoC,SAAS,CAAE,SAAClB,KAAK,CAAEI,MAAM,CAAK,CAC9CJ,KAAK,CAACzB,MAAM,CAAG,YAAY,CAC3ByB,KAAK,CAACvB,KAAK,CAAG0C,KAAK,CAACC,OAAO,CAAChB,MAAM,CAACC,OAAO,CAAC,CAAGD,MAAM,CAACC,OAAO,CAAG,EAAE,CACnE,CAAC,CAAC,CACDW,OAAO,CAAClC,QAAQ,CAACuC,QAAQ,CAAE,SAACrB,KAAK,CAAEI,MAAM,CAAK,CAC7CJ,KAAK,CAACzB,MAAM,CAAG,QAAQ,CACvBgB,OAAO,CAAC+B,KAAK,CAAC,sBAAsB,CAAElB,MAAM,CAACkB,KAAK,CAACC,OAAO,CAAC,CAC3DvB,KAAK,CAACvB,KAAK,CAAG,EAAE,CAAE;AACpB,CAAC,CAAC,CACN,CACF,CAAC,CAAC,CAEF;AACO,qBAWHmB,OAAO,CAAC4B,OAAO,CAVjBzB,WAAW,kBAAXA,WAAW,CACXE,MAAM,kBAANA,MAAM,CACNC,cAAc,kBAAdA,cAAc,CACdC,WAAW,kBAAXA,WAAW,CACXG,WAAW,kBAAXA,WAAW,CACXC,eAAe,kBAAfA,eAAe,CACfC,gBAAgB,kBAAhBA,gBAAgB,CAChBE,gBAAgB,kBAAhBA,gBAAgB,CAChBE,mBAAmB,kBAAnBA,mBAAmB,CACnBC,eAAe,kBAAfA,eAAe,CAGjB;AAAA,wJACA,MAAO,IAAMlD,SAAQ,CAAG,QAAXA,SAAQ,CAAIqC,KAAK,QAAKA,MAAK,CAACyB,SAAS,CAAC9D,QAAQ,GAC3D,MAAO,IAAMC,YAAW,CAAG,QAAdA,YAAW,CAAIoC,KAAK,QAAKA,MAAK,CAACyB,SAAS,CAAC7D,WAAW,GACjE,MAAO,IAAMC,SAAQ,CAAG,QAAXA,SAAQ,CAAImC,KAAK,QAAKA,MAAK,CAACyB,SAAS,CAAC5D,QAAQ,GAC3D,MAAO,IAAMC,SAAQ,CAAG,QAAXA,SAAQ,CAAIkC,KAAK,QAAKA,MAAK,CAACyB,SAAS,CAAC3D,QAAQ,GAC3D,MAAO,IAAMU,OAAM,CAAG,QAATA,OAAM,CAAIwB,KAAK,QAAKA,MAAK,CAACyB,SAAS,CAACjD,MAAM,GAEvD;AACA,MAAO,IAAMkD,QAAO,CAAGnE,cAAc,CAAC,CACpCoE,OAAO,CAAE,CACPF,SAAS,CAAE7B,OAAO,CAAC+B,OACrB,CACF,CAAC,CAAC,CAEF"},"metadata":{},"sourceType":"module"}