{"ast":null,"code":"import _regeneratorRuntime from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _classCallCheck from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/createClass.js\";var WebRTCService=/*#__PURE__*/function(){function WebRTCService(socket){_classCallCheck(this,WebRTCService);this.socket=socket;this.localStream=null;this.peerConnection=null;this.onRemoteStream=null;// STUN servers configuration\nthis.configuration={iceServers:[{urls:['stun:stun1.l.google.com:19302','stun:stun2.l.google.com:19302']}]};}_createClass(WebRTCService,[{key:\"startLocalStream\",value:function(){var _startLocalStream=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(){return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return navigator.mediaDevices.getUserMedia({audio:true,video:true});case 3:this.localStream=_context.sent;return _context.abrupt(\"return\",this.localStream);case 7:_context.prev=7;_context.t0=_context[\"catch\"](0);console.error('Error getting user media:',_context.t0);throw _context.t0;case 11:case\"end\":return _context.stop();}}},_callee,this,[[0,7]]);}));function startLocalStream(){return _startLocalStream.apply(this,arguments);}return startLocalStream;}()},{key:\"createPeerConnection\",value:function(){var _createPeerConnection=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(){var _this=this;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;this.peerConnection=new RTCPeerConnection(this.configuration);// 添加本地流\nif(this.localStream){this.localStream.getTracks().forEach(function(track){_this.peerConnection.addTrack(track,_this.localStream);});}// 处理远程流\nthis.peerConnection.ontrack=function(event){console.log('Received remote track:',event.streams[0]);if(_this.onRemoteStream){_this.onRemoteStream(event.streams[0]);}};// 处理 ICE 候选\nthis.peerConnection.onicecandidate=function(event){if(event.candidate){console.log('New ICE candidate:',event.candidate);// ICE 候选通过 socket 发送给对方\nif(_this.socket){_this.socket.emit('ice-candidate',{candidate:event.candidate});}}};this.peerConnection.oniceconnectionstatechange=function(){console.log('ICE connection state:',_this.peerConnection.iceConnectionState);};return _context2.abrupt(\"return\",this.peerConnection);case 9:_context2.prev=9;_context2.t0=_context2[\"catch\"](0);console.error('Error creating peer connection:',_context2.t0);throw _context2.t0;case 13:case\"end\":return _context2.stop();}}},_callee2,this,[[0,9]]);}));function createPeerConnection(){return _createPeerConnection.apply(this,arguments);}return createPeerConnection;}()},{key:\"createOffer\",value:function(){var _createOffer=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(){var offer;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(this.peerConnection){_context3.next=2;break;}throw new Error('PeerConnection not initialized');case 2:_context3.prev=2;_context3.next=5;return this.peerConnection.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:true});case 5:offer=_context3.sent;console.log('Created offer:',offer);_context3.next=9;return this.peerConnection.setLocalDescription(offer);case 9:return _context3.abrupt(\"return\",offer);case 12:_context3.prev=12;_context3.t0=_context3[\"catch\"](2);console.error('Error creating offer:',_context3.t0);throw _context3.t0;case 16:case\"end\":return _context3.stop();}}},_callee3,this,[[2,12]]);}));function createOffer(){return _createOffer.apply(this,arguments);}return createOffer;}()},{key:\"handleOffer\",value:function(){var _handleOffer=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(offer,fromId){var answer;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(this.peerConnection){_context4.next=2;break;}throw new Error('PeerConnection not initialized');case 2:_context4.prev=2;_context4.next=5;return this.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));case 5:_context4.next=7;return this.peerConnection.createAnswer();case 7:answer=_context4.sent;_context4.next=10;return this.peerConnection.setLocalDescription(answer);case 10:return _context4.abrupt(\"return\",answer);case 13:_context4.prev=13;_context4.t0=_context4[\"catch\"](2);console.error('Error handling offer:',_context4.t0);throw _context4.t0;case 17:case\"end\":return _context4.stop();}}},_callee4,this,[[2,13]]);}));function handleOffer(_x,_x2){return _handleOffer.apply(this,arguments);}return handleOffer;}()},{key:\"handleAnswer\",value:function(){var _handleAnswer=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5(answer){return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(this.peerConnection){_context5.next=2;break;}throw new Error('PeerConnection not initialized');case 2:_context5.prev=2;_context5.next=5;return this.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));case 5:_context5.next=11;break;case 7:_context5.prev=7;_context5.t0=_context5[\"catch\"](2);console.error('Error handling answer:',_context5.t0);throw _context5.t0;case 11:case\"end\":return _context5.stop();}}},_callee5,this,[[2,7]]);}));function handleAnswer(_x3){return _handleAnswer.apply(this,arguments);}return handleAnswer;}()},{key:\"handleIceCandidate\",value:function(){var _handleIceCandidate=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6(candidate){return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:if(this.peerConnection){_context6.next=2;break;}throw new Error('PeerConnection not initialized');case 2:_context6.prev=2;_context6.next=5;return this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));case 5:_context6.next=11;break;case 7:_context6.prev=7;_context6.t0=_context6[\"catch\"](2);console.error('Error handling ICE candidate:',_context6.t0);throw _context6.t0;case 11:case\"end\":return _context6.stop();}}},_callee6,this,[[2,7]]);}));function handleIceCandidate(_x4){return _handleIceCandidate.apply(this,arguments);}return handleIceCandidate;}()},{key:\"closeConnection\",value:function closeConnection(){if(this.peerConnection){this.peerConnection.close();this.peerConnection=null;}if(this.localStream){this.localStream.getTracks().forEach(function(track){return track.stop();});this.localStream=null;}}}]);return WebRTCService;}();export default WebRTCService;","map":{"version":3,"names":["WebRTCService","socket","localStream","peerConnection","onRemoteStream","configuration","iceServers","urls","navigator","mediaDevices","getUserMedia","audio","video","console","error","RTCPeerConnection","getTracks","forEach","track","addTrack","ontrack","event","log","streams","onicecandidate","candidate","emit","oniceconnectionstatechange","iceConnectionState","Error","createOffer","offerToReceiveAudio","offerToReceiveVideo","offer","setLocalDescription","fromId","setRemoteDescription","RTCSessionDescription","createAnswer","answer","addIceCandidate","RTCIceCandidate","close","stop"],"sources":["/Users/feng/Work/Project/df/df.im/df.im.client/src/services/webrtc.js"],"sourcesContent":["class WebRTCService {\n  constructor(socket) {\n    this.socket = socket;\n    this.localStream = null;\n    this.peerConnection = null;\n    this.onRemoteStream = null;\n\n    // STUN servers configuration\n    this.configuration = {\n      iceServers: [\n        {\n          urls: [\n            'stun:stun1.l.google.com:19302',\n            'stun:stun2.l.google.com:19302',\n          ],\n        },\n      ],\n    };\n  }\n\n  async startLocalStream() {\n    try {\n      this.localStream = await navigator.mediaDevices.getUserMedia({\n        audio: true,\n        video: true\n      });\n      return this.localStream;\n    } catch (error) {\n      console.error('Error getting user media:', error);\n      throw error;\n    }\n  }\n\n  async createPeerConnection() {\n    try {\n      this.peerConnection = new RTCPeerConnection(this.configuration);\n\n      // 添加本地流\n      if (this.localStream) {\n        this.localStream.getTracks().forEach(track => {\n          this.peerConnection.addTrack(track, this.localStream);\n        });\n      }\n\n      // 处理远程流\n      this.peerConnection.ontrack = (event) => {\n        console.log('Received remote track:', event.streams[0]);\n        if (this.onRemoteStream) {\n          this.onRemoteStream(event.streams[0]);\n        }\n      };\n\n      // 处理 ICE 候选\n      this.peerConnection.onicecandidate = (event) => {\n        if (event.candidate) {\n          console.log('New ICE candidate:', event.candidate);\n          // ICE 候选通过 socket 发送给对方\n          if (this.socket) {\n            this.socket.emit('ice-candidate', {\n              candidate: event.candidate\n            });\n          }\n        }\n      };\n\n      this.peerConnection.oniceconnectionstatechange = () => {\n        console.log('ICE connection state:', this.peerConnection.iceConnectionState);\n      };\n\n      return this.peerConnection;\n    } catch (error) {\n      console.error('Error creating peer connection:', error);\n      throw error;\n    }\n  }\n\n  async createOffer() {\n    if (!this.peerConnection) {\n      throw new Error('PeerConnection not initialized');\n    }\n\n    try {\n      const offer = await this.peerConnection.createOffer({\n        offerToReceiveAudio: true,\n        offerToReceiveVideo: true\n      });\n      \n      console.log('Created offer:', offer);\n      await this.peerConnection.setLocalDescription(offer);\n      return offer;\n    } catch (error) {\n      console.error('Error creating offer:', error);\n      throw error;\n    }\n  }\n\n  async handleOffer(offer, fromId) {\n    if (!this.peerConnection) {\n      throw new Error('PeerConnection not initialized');\n    }\n\n    try {\n      await this.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));\n      const answer = await this.peerConnection.createAnswer();\n      await this.peerConnection.setLocalDescription(answer);\n      return answer;\n    } catch (error) {\n      console.error('Error handling offer:', error);\n      throw error;\n    }\n  }\n\n  async handleAnswer(answer) {\n    if (!this.peerConnection) {\n      throw new Error('PeerConnection not initialized');\n    }\n\n    try {\n      await this.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));\n    } catch (error) {\n      console.error('Error handling answer:', error);\n      throw error;\n    }\n  }\n\n  async handleIceCandidate(candidate) {\n    if (!this.peerConnection) {\n      throw new Error('PeerConnection not initialized');\n    }\n\n    try {\n      await this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));\n    } catch (error) {\n      console.error('Error handling ICE candidate:', error);\n      throw error;\n    }\n  }\n\n  closeConnection() {\n    if (this.peerConnection) {\n      this.peerConnection.close();\n      this.peerConnection = null;\n    }\n\n    if (this.localStream) {\n      this.localStream.getTracks().forEach(track => track.stop());\n      this.localStream = null;\n    }\n  }\n}\n\nexport default WebRTCService;"],"mappings":"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"},"metadata":{},"sourceType":"module"}