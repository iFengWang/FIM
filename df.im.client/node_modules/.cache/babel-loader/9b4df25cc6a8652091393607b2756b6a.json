{"ast":null,"code":"import _toConsumableArray from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _createForOfIteratorHelper from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _regeneratorRuntime from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import React,{useState,useCallback,useEffect,useRef}from\"react\";import WebRTCService from\"../services/webrtc\";import{FullScreen,useFullScreenHandle}from\"react-full-screen\";import{useSelector,useDispatch}from\"react-redux\";import{useSocket}from\"../contexts/imSocket\";import{addUnreadMessage,setIncomingCall}from\"./imStore\";import{togglerChat,clearUnreadMessages}from\"./imStore\";import{FontAwesomeIcon}from\"@fortawesome/react-fontawesome\";import{faXmark,faCompress,faPhone,faPhoneSlash,faVideo,faSmile,faFile,faScissors,faMicrophone,faArrowPointer,faCamera,faEye,faFilm,faQrcode,faRecordVinyl,faMoneyBillTransfer,faPaperPlane,faUser}from\"@fortawesome/free-solid-svg-icons\";import{ImDialog}from\"./imCore\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";function ImChat(props){// private state *************************************\nvar _useState=useState(false),_useState2=_slicedToArray(_useState,2),full=_useState2[0],setFull=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),hideControl=_useState4[0],setHideControl=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),hideLocalVideo=_useState6[0],setHideLocalVideo=_useState6[1];var _useState7=useState(1),_useState8=_slicedToArray(_useState7,2),mode=_useState8[0],setMode=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),showVideoInvite=_useState10[0],setShowVideoInvite=_useState10[1];var incomingCall=useSelector(function(state){return state.imReducer.incomingCall;});var webrtcRef=useRef(null);var _useState11=useState(\"\"),_useState12=_slicedToArray(_useState11,2),message=_useState12[0],setMessage=_useState12[1];var _useState13=useState([]),_useState14=_slicedToArray(_useState13,2),messages=_useState14[0],setMessages=_useState14[1];var messagesEndRef=useRef(null);var handle=useFullScreenHandle();var scrollToBottom=function scrollToBottom(){var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView({behavior:\"smooth\"});};// public state *************************************\nvar dispatch=useDispatch();var _useSocket=useSocket(),socket=_useSocket.socket,connected=_useSocket.connected,sendMessage=_useSocket.sendMessage,sendVideoInvite=_useSocket.sendVideoInvite,sendVideoAccept=_useSocket.sendVideoAccept,sendVideoReject=_useSocket.sendVideoReject,sendVideoOffer=_useSocket.sendVideoOffer,sendVideoAnswer=_useSocket.sendVideoAnswer,sendIceCandidate=_useSocket.sendIceCandidate,sendVideoEnd=_useSocket.sendVideoEnd,getHistoryMessages=_useSocket.getHistoryMessages;var size=useSelector(function(rootState){return rootState.imReducer.size;});var currentChatUser=useSelector(function(rootState){return rootState.imReducer.currentChatUser;});var bounds={left:full?0:size.left,top:full?0:size.top,right:size.right-170,bottom:size.bottom-50};// let localVideoref = React.createRef();\n// let localStream = null;\nvar localVideoref=useRef(null);var remoteVideoref=useRef(null);var onChange=useCallback(function(state,handle){setFull(state);},[]);// component logic *************************************\nvar showControl=function showControl(){return hideControl?null:/*#__PURE__*/_jsxs(\"div\",{className:\"control-panel\",children:[/*#__PURE__*/_jsx(\"button\",{id:\"callBtn\",className:\"im-chat-control-btn\",onClick:function onClick(){// 发送结束视频信号给对方\nif(currentChatUser&&currentChatUser.uid){sendVideoEnd(currentChatUser.uid);}// 本地关闭视频\nstopVideoCall();setMode(1);// 切换回文字聊天模式\n},children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faPhoneSlash})}),/*#__PURE__*/_jsx(\"button\",{id:\"muteBtn\",className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faMicrophone})}),/*#__PURE__*/_jsx(\"button\",{id:\"closeVideoBtn\",className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faVideo})}),/*#__PURE__*/_jsx(\"button\",{id:\"fullScreenBtn\",className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faArrowPointer})}),/*#__PURE__*/_jsx(\"button\",{id:\"switchCameraBtn\",className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faCamera})}),/*#__PURE__*/_jsx(\"button\",{id:\"hideBtn\",className:\"im-chat-control-btn\",onClick:function onClick(){return setHideLocalVideo(!hideLocalVideo);},children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faEye})}),/*#__PURE__*/_jsx(\"button\",{id:\"screenBtn\",className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faFilm})}),/*#__PURE__*/_jsx(\"button\",{id:\"qrBtn\",className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faQrcode})}),/*#__PURE__*/_jsx(\"button\",{id:\"boardBtn\",className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faMoneyBillTransfer})}),/*#__PURE__*/_jsx(\"button\",{id:\"recordBtn\",className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faRecordVinyl})})]});};useEffect(function(){if(!socket)return;// 初始化WebRTC服务\nwebrtcRef.current=new WebRTCService(socket);webrtcRef.current.onRemoteStream=function(stream){if(remoteVideoref.current){remoteVideoref.current.srcObject=stream;}};var handleVideoInviteSent=function handleVideoInviteSent(event){var data=event.detail;console.log(\"Video invite sent successfully:\",data);if(data.success){setShowVideoInvite(true);}};var handleVideoInviteFailed=function handleVideoInviteFailed(event){var data=event.detail;console.log(\"Video invite failed:\",data);alert(\"\\u65E0\\u6CD5\\u53D1\\u8D77\\u89C6\\u9891\\u901A\\u8BDD\\uFF1A\".concat(data.error));setShowVideoInvite(false);stopVideoCall();};var handleVideoAccept=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(event){var data,offer;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:data=event.detail;console.log(\"Video call accepted, starting local stream...\");_context.prev=2;_context.next=5;return startVideoCall(true);case 5:console.log(\"Local stream started, creating offer...\");// 创建并发送 offer\n_context.next=8;return webrtcRef.current.createOffer();case 8:offer=_context.sent;console.log(\"Offer created:\",offer);sendVideoOffer(data.from,offer);_context.next=17;break;case 13:_context.prev=13;_context.t0=_context[\"catch\"](2);console.error(\"Error in handleVideoAccept:\",_context.t0);stopVideoCall();case 17:case\"end\":return _context.stop();}}},_callee,null,[[2,13]]);}));return function handleVideoAccept(_x){return _ref.apply(this,arguments);};}();var handleVideoReject=function handleVideoReject(){setShowVideoInvite(false);stopVideoCall();};var handleVideoOffer=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(event){var data,answer;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:data=event.detail;console.log(\"Received video offer:\",data);_context2.prev=2;_context2.next=5;return startVideoCall(false);case 5:console.log(\"Local stream started for receiver\");// 处理 offer 并创建 answer\n_context2.next=8;return webrtcRef.current.handleOffer(data.offer,data.from);case 8:answer=_context2.sent;console.log(\"Created answer:\",answer);// 发送 answer\nsendVideoAnswer(data.from,answer);_context2.next=17;break;case 13:_context2.prev=13;_context2.t0=_context2[\"catch\"](2);console.error(\"Error in handleVideoOffer:\",_context2.t0);stopVideoCall();case 17:case\"end\":return _context2.stop();}}},_callee2,null,[[2,13]]);}));return function handleVideoOffer(_x2){return _ref2.apply(this,arguments);};}();var handleVideoAnswer=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(event){var data;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:data=event.detail;_context3.prev=1;_context3.next=4;return webrtcRef.current.handleAnswer(data.answer);case 4:_context3.next=9;break;case 6:_context3.prev=6;_context3.t0=_context3[\"catch\"](1);console.error(\"Error handling video answer:\",_context3.t0);case 9:case\"end\":return _context3.stop();}}},_callee3,null,[[1,6]]);}));return function handleVideoAnswer(_x3){return _ref3.apply(this,arguments);};}();var handleIceCandidate=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(event){var data;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:data=event.detail;_context4.prev=1;_context4.next=4;return webrtcRef.current.handleIceCandidate(data.candidate);case 4:_context4.next=9;break;case 6:_context4.prev=6;_context4.t0=_context4[\"catch\"](1);console.error(\"Error handling ICE candidate:\",_context4.t0);case 9:case\"end\":return _context4.stop();}}},_callee4,null,[[1,6]]);}));return function handleIceCandidate(_x4){return _ref4.apply(this,arguments);};}();var handleVideoEnd=function handleVideoEnd(){stopVideoCall();};window.addEventListener(\"video_invite_sent\",handleVideoInviteSent);window.addEventListener(\"video_invite_failed\",handleVideoInviteFailed);window.addEventListener(\"video_accept\",handleVideoAccept);window.addEventListener(\"video_reject\",handleVideoReject);window.addEventListener(\"video_offer\",handleVideoOffer);window.addEventListener(\"video_answer\",handleVideoAnswer);window.addEventListener(\"ice_candidate\",handleIceCandidate);window.addEventListener(\"video_end\",handleVideoEnd);return function(){window.removeEventListener(\"video_invite_sent\",handleVideoInviteSent);window.removeEventListener(\"video_invite_failed\",handleVideoInviteFailed);window.removeEventListener(\"video_accept\",handleVideoAccept);window.removeEventListener(\"video_reject\",handleVideoReject);window.removeEventListener(\"video_offer\",handleVideoOffer);window.removeEventListener(\"video_answer\",handleVideoAnswer);window.removeEventListener(\"ice_candidate\",handleIceCandidate);window.removeEventListener(\"video_end\",handleVideoEnd);stopVideoCall();};},[socket,currentChatUser]);var startVideoCall=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5(isInitiator){return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.prev=0;console.log(\"Starting video call as\",isInitiator?\"initiator\":\"receiver\");// 切换到视频模式\nsetMode(2);console.log(\"Switched to video mode\");// 等待一下确保视频元素已经渲染\n_context5.next=6;return new Promise(function(resolve){return setTimeout(resolve,100);});case 6:_context5.next=8;return webrtcRef.current.startLocalStream();case 8:console.log(\"Local stream started\");// 设置本地视频显示\nif(localVideoref.current){localVideoref.current.srcObject=webrtcRef.current.localStream;console.log(\"Local video element set up\");}else{console.error(\"Local video element not found\");console.log(\"localVideoref:\",localVideoref);}// 创建对等连接\n_context5.next=12;return webrtcRef.current.createPeerConnection();case 12:console.log(\"Peer connection created\");_context5.next=20;break;case 15:_context5.prev=15;_context5.t0=_context5[\"catch\"](0);console.error(\"Error in startVideoCall:\",_context5.t0);stopVideoCall();throw _context5.t0;case 20:case\"end\":return _context5.stop();}}},_callee5,null,[[0,15]]);}));return function startVideoCall(_x5){return _ref5.apply(this,arguments);};}();var stopVideoCall=function stopVideoCall(){console.log(\"开始停止视频通话...\");// 立即切换到文字模式，确保UI响应迅速\nsetMode(1);var forceStopStream=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6(stream){var tracks;return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:if(stream){_context6.next=2;break;}return _context6.abrupt(\"return\");case 2:_context6.prev=2;tracks=stream.getTracks();console.log(\"\\u505C\\u6B62 \".concat(tracks.length,\" \\u4E2A\\u5A92\\u4F53\\u8F68\\u9053\"));// 先禁用所有轨道\ntracks.forEach(function(track){track.enabled=false;track.muted=true;});// 等待一小段时间确保禁用生效\n_context6.next=8;return new Promise(function(resolve){return setTimeout(resolve,10);});case 8:// 然后停止所有轨道\ntracks.forEach(function(track){try{track.stop();stream.removeTrack(track);console.log(\"\\u6210\\u529F\\u505C\\u6B62\\u5E76\\u79FB\\u9664\\u8F68\\u9053: \".concat(track.kind));}catch(err){console.error(\"\\u505C\\u6B62\\u8F68\\u9053\\u5931\\u8D25: \".concat(track.kind),err);}});_context6.next=14;break;case 11:_context6.prev=11;_context6.t0=_context6[\"catch\"](2);console.error(\"停止媒体流失败:\",_context6.t0);case 14:case\"end\":return _context6.stop();}}},_callee6,null,[[2,11]]);}));return function forceStopStream(_x6){return _ref6.apply(this,arguments);};}();var cleanup=/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee7(){var devices,videoDevices,_iterator,_step,device,stream;return _regeneratorRuntime().wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.prev=0;if(!webrtcRef.current){_context7.next=9;break;}console.log(\"关闭 WebRTC 连接\");webrtcRef.current.closeConnection();if(!webrtcRef.current.localStream){_context7.next=9;break;}console.log(\"停止 WebRTC 本地流\");_context7.next=8;return forceStopStream(webrtcRef.current.localStream);case 8:webrtcRef.current.localStream=null;case 9:if(!(localVideoref.current&&localVideoref.current.srcObject)){_context7.next=15;break;}console.log(\"清理本地视频元素\");_context7.next=13;return forceStopStream(localVideoref.current.srcObject);case 13:localVideoref.current.srcObject=null;localVideoref.current.load();// 强制重载视频元素\ncase 15:if(!(remoteVideoref.current&&remoteVideoref.current.srcObject)){_context7.next=21;break;}console.log(\"清理远程视频元素\");_context7.next=19;return forceStopStream(remoteVideoref.current.srcObject);case 19:remoteVideoref.current.srcObject=null;remoteVideoref.current.load();// 强制重载视频元素\ncase 21:_context7.next=23;return navigator.mediaDevices.enumerateDevices();case 23:devices=_context7.sent;videoDevices=devices.filter(function(device){return device.kind==='videoinput';});_iterator=_createForOfIteratorHelper(videoDevices);_context7.prev=26;_iterator.s();case 28:if((_step=_iterator.n()).done){_context7.next=43;break;}device=_step.value;_context7.prev=30;_context7.next=33;return navigator.mediaDevices.getUserMedia({video:{deviceId:device.deviceId},audio:false});case 33:stream=_context7.sent;_context7.next=36;return forceStopStream(stream);case 36:_context7.next=41;break;case 38:_context7.prev=38;_context7.t0=_context7[\"catch\"](30);console.log(\"\\u8BBE\\u5907 \".concat(device.label,\" \\u5DF2\\u91CA\\u653E\"));case 41:_context7.next=28;break;case 43:_context7.next=48;break;case 45:_context7.prev=45;_context7.t1=_context7[\"catch\"](26);_iterator.e(_context7.t1);case 48:_context7.prev=48;_iterator.f();return _context7.finish(48);case 51:// 5. 请求垃圾回收\nif(window.gc){window.gc();}console.log(\"视频通话停止完成\");_context7.next=58;break;case 55:_context7.prev=55;_context7.t2=_context7[\"catch\"](0);console.error(\"清理过程中出错:\",_context7.t2);case 58:case\"end\":return _context7.stop();}}},_callee7,null,[[0,55],[26,45,48,51],[30,38]]);}));return function cleanup(){return _ref7.apply(this,arguments);};}();// 执行清理\ncleanup();};var handleVideoButtonClick=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee8(){return _regeneratorRuntime().wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.prev=0;if(currentChatUser){_context8.next=4;break;}console.error(\"No chat user selected\");return _context8.abrupt(\"return\");case 4:if(!(mode===1)){_context8.next=17;break;}// 发送视频通话邀请\nsendVideoInvite(currentChatUser.uid);// 预启动本地视频\n_context8.prev=6;_context8.next=9;return webrtcRef.current.startLocalStream();case 9:if(localVideoref.current){localVideoref.current.srcObject=webrtcRef.current.localStream;}_context8.next=15;break;case 12:_context8.prev=12;_context8.t0=_context8[\"catch\"](6);console.error(\"Error starting local stream:\",_context8.t0);case 15:_context8.next=19;break;case 17:// 结束视频通话\nsendVideoEnd(currentChatUser.uid);stopVideoCall();case 19:_context8.next=24;break;case 21:_context8.prev=21;_context8.t1=_context8[\"catch\"](0);console.error(\"Error in handleVideoButtonClick:\",_context8.t1);case 24:case\"end\":return _context8.stop();}}},_callee8,null,[[0,21],[6,12]]);}));return function handleVideoButtonClick(){return _ref8.apply(this,arguments);};}();// 视频通话接受\nvar handleAcceptCall=/*#__PURE__*/function(){var _ref9=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee9(){return _regeneratorRuntime().wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:if(incomingCall){_context9.next=2;break;}return _context9.abrupt(\"return\");case 2:sendVideoAccept(incomingCall.from);dispatch(setIncomingCall(null));case 4:case\"end\":return _context9.stop();}}},_callee9);}));return function handleAcceptCall(){return _ref9.apply(this,arguments);};}();// 视频通话拒绝\nvar handleRejectCall=function handleRejectCall(){if(!incomingCall)return;sendVideoReject(incomingCall.from);dispatch(setIncomingCall(null));};// 发送消息\nvar handleSendMessage=function handleSendMessage(){if(!message.trim())return;if(currentChatUser&&currentChatUser.uid){sendMessage(currentChatUser.uid,message.trim());setMessage(\"\");}else{console.error(\"No valid chat user selected\");}};// 接收消息\nuseEffect(function(){var handleMessage=function handleMessage(event){var _msg$from,_msg$account;var msg=event.detail;// 只显示当前聊天用户的消息\nif(currentChatUser&&(((_msg$from=msg.from)===null||_msg$from===void 0?void 0:_msg$from.id)===currentChatUser.uid||((_msg$account=msg.account)===null||_msg$account===void 0?void 0:_msg$account.id)===currentChatUser.uid)){setMessages(function(prev){return[].concat(_toConsumableArray(prev),[msg]);});scrollToBottom();}};if(socket){window.addEventListener(\"im_message\",handleMessage);socket.on(\"history_messages\",function(messages){console.log(\"Received history messages:\",messages);// 过滤消息，只显示与当前聊天用户相关的消息\nvar filteredMessages=messages.filter(function(msg){var _msg$from2,_msg$account2;return currentChatUser&&(((_msg$from2=msg.from)===null||_msg$from2===void 0?void 0:_msg$from2.id)===currentChatUser.uid||((_msg$account2=msg.account)===null||_msg$account2===void 0?void 0:_msg$account2.id)===currentChatUser.uid);});setMessages(filteredMessages);scrollToBottom();});}return function(){window.removeEventListener(\"im_message\",handleMessage);if(socket){socket.off(\"history_messages\");}};},[socket,currentChatUser]);// 当打开聊天窗口时，加载历史消息\nuseEffect(function(){if(socket&&currentChatUser){// 清除未读消息计数\ndispatch(clearUnreadMessages({uid:currentChatUser.uid}));// 请求历史消息\ngetHistoryMessages(currentChatUser.uid);// 清空当前消息列表\nsetMessages([]);// 更新全局变量，用于未读消息计数判断\nwindow.currentChatUser=currentChatUser;}// 组件卸载时清除全局变量\nreturn function(){window.currentChatUser=null;};},[socket,currentChatUser,dispatch]);useEffect(function(){scrollToBottom();},[messages]);var showLocalVideo=function showLocalVideo(){return hideLocalVideo?null:/*#__PURE__*/_jsxs(ImDialog,{padding:\"0px\",axis:\"both\",style:{position:\"absolute\",// 添加绝对定位\ntop:\"20px\",// 距离顶部20px\nright:\"20px\",// 距离右侧20px\nwidth:\"150px\",height:\"150px\",minWidth:\"100px\",minHeight:\"100px\",backgroundColor:\"#000\",borderRadius:\"8px\",overflow:\"hidden\",boxShadow:\"0 4px 8px rgba(0,0,0,0.3)\",resize:\"both\",zIndex:1000}// bounds=\".im-frame\" // 限制拖拽范围在视频聊天窗口内\n,children:[/*#__PURE__*/_jsx(\"video\",{id:\"localVideo\",ref:localVideoref,autoPlay:true,muted:true,playsInline:true,onDoubleClick:swapVideoStreams}),/*#__PURE__*/_jsx(\"button\",{className:\"btn-close\",onClick:function onClick(){// 发送结束视频信号给对方\nif(currentChatUser&&currentChatUser.uid){sendVideoEnd(currentChatUser.uid);}// 本地关闭视频\nsetHideLocalVideo(true);stopVideoCall();setMode(1);// 切换回文字聊天模式\n},children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faXmark})})]});};// 交换视频流\nvar swapVideoStreams=function swapVideoStreams(){if(!localVideoref.current||!remoteVideoref.current)return;var localStream=localVideoref.current.srcObject;var remoteStream=remoteVideoref.current.srcObject;localVideoref.current.srcObject=remoteStream;remoteVideoref.current.srcObject=localStream;};var videoMode=function videoMode(){console.log(\"Rendering video mode, localVideoref:\",localVideoref.current);return/*#__PURE__*/_jsx(\"div\",{className:\"im-frame\",children:/*#__PURE__*/_jsxs(\"div\",{style:{position:\"relative\",width:\"100%\",height:\"100%\"},children:[/*#__PURE__*/_jsx(\"video\",{id:\"remoteVideo\",ref:remoteVideoref,autoPlay:true,playsInline:true,style:{width:\"100%\",height:\"100%\",objectFit:\"cover\",backgroundColor:\"#000\"},onClick:function onClick(){return setHideControl(!hideControl);}}),!hideLocalVideo&&showLocalVideo(),showControl()]})});};var textMode=function textMode(){return/*#__PURE__*/_jsxs(\"div\",{className:\"im-frame\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"im-chat\",style:{flex:1,padding:\"10px\",overflow:\"auto\"},children:[messages.map(function(msg,index){var _msg$from3,_msg$from4;var currentUid=parseInt(new URLSearchParams(window.location.search).get(\"uId\"));var isMe=((_msg$from3=msg.from)===null||_msg$from3===void 0?void 0:_msg$from3.id)===currentUid;console.log(\"Message sender:\",(_msg$from4=msg.from)===null||_msg$from4===void 0?void 0:_msg$from4.id,\"Current user:\",currentUid,\"isMe:\",isMe);var time=new Date(msg.timestamp).toLocaleString();if(index===0||new Date(msg.timestamp).getDate()!==new Date(messages[index-1].timestamp).getDate()){return/*#__PURE__*/_jsxs(React.Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"im-chat-time\",children:time}),/*#__PURE__*/_jsxs(\"div\",{className:isMe?\"me-chat-panel\":\"you-chat-panel\",children:[!isMe&&/*#__PURE__*/_jsx(\"button\",{className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faUser})}),/*#__PURE__*/_jsx(\"div\",{className:isMe?\"me-chat\":\"you-chat\",children:msg.content}),isMe&&/*#__PURE__*/_jsx(\"button\",{className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faUser})})]})]},index);}return/*#__PURE__*/_jsxs(\"div\",{className:isMe?\"me-chat-panel\":\"you-chat-panel\",children:[!isMe&&/*#__PURE__*/_jsx(\"button\",{className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faUser})}),/*#__PURE__*/_jsx(\"div\",{className:isMe?\"me-chat\":\"you-chat\",children:msg.content}),isMe&&/*#__PURE__*/_jsx(\"button\",{className:\"im-chat-control-btn\",children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faUser})})]},index);}),/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"im-chat\",children:[/*#__PURE__*/_jsxs(\"div\",{style:{padding:\"5px\"},children:[/*#__PURE__*/_jsx(\"button\",{className:\"im-header-button\",onClick:function onClick(){return dispatch(togglerChat(currentChatUser));},onTouchEnd:function onTouchEnd(){return dispatch(togglerChat(currentChatUser));},children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faSmile})}),/*#__PURE__*/_jsx(\"button\",{className:\"im-header-button\",onClick:function onClick(){return dispatch(togglerChat(currentChatUser));},onTouchEnd:function onTouchEnd(){return dispatch(togglerChat(currentChatUser));},children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faFile})}),/*#__PURE__*/_jsx(\"button\",{className:\"im-header-button\",onClick:function onClick(){return dispatch(togglerChat(currentChatUser));},onTouchEnd:function onTouchEnd(){return dispatch(togglerChat(currentChatUser));},children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faScissors})}),/*#__PURE__*/_jsx(\"button\",{className:\"im-header-button\",onClick:function onClick(){return dispatch(togglerChat());},onTouchEnd:function onTouchEnd(){return dispatch(togglerChat());},children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faPhone})}),/*#__PURE__*/_jsx(\"button\",{className:\"im-header-button\",onClick:function onClick(){console.log(\"Video button clicked\");console.log(\"Current chat user:\",currentChatUser);handleVideoButtonClick();},onTouchEnd:handleVideoButtonClick,children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faVideo})}),/*#__PURE__*/_jsx(\"button\",{className:\"im-header-button\",onClick:handleSendMessage,onTouchEnd:handleSendMessage,children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faPaperPlane})})]}),/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsx(\"textarea\",{className:\"im-input\",type:\"text\",placeholder:\"\\u5728\\u6B64\\u8F93\\u5165\\u6587\\u672C\\u6D88\\u606F\\uFF0C\\u6309\\u56DE\\u8F66\\u952E\\u53D1\\u9001\",value:message,onChange:function onChange(e){return setMessage(e.target.value);},onKeyPress:function onKeyPress(e){if(e.key===\"Enter\"&&!e.shiftKey){e.preventDefault();handleSendMessage();}},required:true})})]})]});};return/*#__PURE__*/_jsx(FullScreen,{handle:handle,onChange:onChange,children:/*#__PURE__*/_jsx(ImDialog,{point:{x:full?0:bounds.left+230,y:full?0:bounds.top},bounds:bounds,title:/*#__PURE__*/_jsx(\"span\",{className:\"im-header-title\",children:(currentChatUser===null||currentChatUser===void 0?void 0:currentChatUser.name)||\"聊天\"}),buttons:/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"button\",{className:\"im-header-button\",onClick:function onClick(){if(!full){setFull(true);handle.enter();}else{setFull(false);handle.exit();}},onTouchEnd:handle.enter,children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faCompress})}),/*#__PURE__*/_jsx(\"button\",{className:\"im-header-button\",onClick:function onClick(){return dispatch(togglerChat(null));},onTouchEnd:function onTouchEnd(){return dispatch(togglerChat(null));},children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:faXmark})})]}),style:{width:full?\"100vw\":500,height:full?\"100vh\":500,resize:full?\"none\":\"both\",minWidth:400,minHeight:400},axis:full?\"none\":\"both\",cancel:\".im-frame\",children:mode===1?textMode():videoMode()})});}export default ImChat;","map":{"version":3,"names":["React","useState","useCallback","useEffect","useRef","WebRTCService","FullScreen","useFullScreenHandle","useSelector","useDispatch","useSocket","addUnreadMessage","setIncomingCall","togglerChat","clearUnreadMessages","FontAwesomeIcon","faXmark","faCompress","faPhone","faPhoneSlash","faVideo","faSmile","faFile","faScissors","faMicrophone","faArrowPointer","faCamera","faEye","faFilm","faQrcode","faRecordVinyl","faMoneyBillTransfer","faPaperPlane","faUser","ImDialog","ImChat","props","full","setFull","hideControl","setHideControl","hideLocalVideo","setHideLocalVideo","mode","setMode","showVideoInvite","setShowVideoInvite","incomingCall","state","imReducer","webrtcRef","message","setMessage","messages","setMessages","messagesEndRef","handle","scrollToBottom","current","scrollIntoView","behavior","dispatch","socket","connected","sendMessage","sendVideoInvite","sendVideoAccept","sendVideoReject","sendVideoOffer","sendVideoAnswer","sendIceCandidate","sendVideoEnd","getHistoryMessages","size","rootState","currentChatUser","bounds","left","top","right","bottom","localVideoref","remoteVideoref","onChange","showControl","uid","stopVideoCall","onRemoteStream","stream","srcObject","handleVideoInviteSent","event","data","detail","console","log","success","handleVideoInviteFailed","alert","error","handleVideoAccept","startVideoCall","createOffer","offer","from","handleVideoReject","handleVideoOffer","handleOffer","answer","handleVideoAnswer","handleAnswer","handleIceCandidate","candidate","handleVideoEnd","window","addEventListener","removeEventListener","isInitiator","Promise","resolve","setTimeout","startLocalStream","localStream","createPeerConnection","forceStopStream","tracks","getTracks","length","forEach","track","enabled","muted","stop","removeTrack","kind","err","cleanup","closeConnection","load","navigator","mediaDevices","enumerateDevices","devices","videoDevices","filter","device","getUserMedia","video","deviceId","audio","label","gc","handleVideoButtonClick","handleAcceptCall","handleRejectCall","handleSendMessage","trim","handleMessage","msg","id","account","prev","on","filteredMessages","off","showLocalVideo","position","width","height","minWidth","minHeight","backgroundColor","borderRadius","overflow","boxShadow","resize","zIndex","swapVideoStreams","remoteStream","videoMode","objectFit","textMode","flex","padding","map","index","currentUid","parseInt","URLSearchParams","location","search","get","isMe","time","Date","timestamp","toLocaleString","getDate","content","e","target","value","key","shiftKey","preventDefault","x","y","name","enter","exit"],"sources":["/Users/feng/Work/Project/df/df.im/df.im.client/src/im/imChat.js"],"sourcesContent":["import React, { useState, useCallback, useEffect, useRef } from \"react\";\nimport WebRTCService from \"../services/webrtc\";\nimport { FullScreen, useFullScreenHandle } from \"react-full-screen\";\nimport { useSelector, useDispatch } from \"react-redux\";\nimport { useSocket } from \"../contexts/imSocket\";\nimport { addUnreadMessage, setIncomingCall } from \"./imStore\";\nimport { togglerChat, clearUnreadMessages } from \"./imStore\";\nimport { FontAwesomeIcon } from \"@fortawesome/react-fontawesome\";\nimport {\n  faXmark,\n  faCompress,\n  faPhone,\n  faPhoneSlash,\n  faVideo,\n  faSmile,\n  faFile,\n  faScissors,\n  faMicrophone,\n  faArrowPointer,\n  faCamera,\n  faEye,\n  faFilm,\n  faQrcode,\n  faRecordVinyl,\n  faMoneyBillTransfer,\n  faPaperPlane,\n  faUser,\n} from \"@fortawesome/free-solid-svg-icons\";\nimport { ImDialog } from \"./imCore\";\n\nfunction ImChat(props) {\n  // private state *************************************\n  const [full, setFull] = useState(false);\n  const [hideControl, setHideControl] = useState(false);\n  const [hideLocalVideo, setHideLocalVideo] = useState(false);\n  const [mode, setMode] = useState(1);\n  const [showVideoInvite, setShowVideoInvite] = useState(false);\n  const incomingCall = useSelector((state) => state.imReducer.incomingCall);\n  const webrtcRef = useRef(null);\n  const [message, setMessage] = useState(\"\");\n  const [messages, setMessages] = useState([]);\n  const messagesEndRef = useRef(null);\n  const handle = useFullScreenHandle();\n\n  const scrollToBottom = () => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  };\n\n  // public state *************************************\n  const dispatch = useDispatch();\n  const {\n    socket,\n    connected,\n    sendMessage,\n    sendVideoInvite,\n    sendVideoAccept,\n    sendVideoReject,\n    sendVideoOffer,\n    sendVideoAnswer,\n    sendIceCandidate,\n    sendVideoEnd,\n    getHistoryMessages,\n  } = useSocket();\n  const size = useSelector((rootState) => rootState.imReducer.size);\n  const currentChatUser = useSelector(\n    (rootState) => rootState.imReducer.currentChatUser\n  );\n  let bounds = {\n    left: full ? 0 : size.left,\n    top: full ? 0 : size.top,\n    right: size.right - 170,\n    bottom: size.bottom - 50,\n  };\n\n  // let localVideoref = React.createRef();\n  // let localStream = null;\n\n  const localVideoref = useRef(null);\n  const remoteVideoref = useRef(null);\n\n  const onChange = useCallback((state, handle) => {\n    setFull(state);\n  }, []);\n\n  // component logic *************************************\n  const showControl = () => {\n    return hideControl ? null : (\n      <div className=\"control-panel\">\n        <button\n          id=\"callBtn\"\n          className=\"im-chat-control-btn\"\n          onClick={() => {\n            // 发送结束视频信号给对方\n            if (currentChatUser && currentChatUser.uid) {\n              sendVideoEnd(currentChatUser.uid);\n            }\n            // 本地关闭视频\n            stopVideoCall();\n            setMode(1); // 切换回文字聊天模式\n          }}\n        >\n          <FontAwesomeIcon icon={faPhoneSlash} />\n        </button>\n        <button id=\"muteBtn\" className=\"im-chat-control-btn\">\n          <FontAwesomeIcon icon={faMicrophone} />\n        </button>\n        <button id=\"closeVideoBtn\" className=\"im-chat-control-btn\">\n          <FontAwesomeIcon icon={faVideo} />\n        </button>\n        <button id=\"fullScreenBtn\" className=\"im-chat-control-btn\">\n          <FontAwesomeIcon icon={faArrowPointer} />\n        </button>\n        <button id=\"switchCameraBtn\" className=\"im-chat-control-btn\">\n          <FontAwesomeIcon icon={faCamera} />\n        </button>\n        <button\n          id=\"hideBtn\"\n          className=\"im-chat-control-btn\"\n          onClick={() => setHideLocalVideo(!hideLocalVideo)}\n        >\n          <FontAwesomeIcon icon={faEye} />\n        </button>\n        <button id=\"screenBtn\" className=\"im-chat-control-btn\">\n          <FontAwesomeIcon icon={faFilm} />\n        </button>\n        <button id=\"qrBtn\" className=\"im-chat-control-btn\">\n          <FontAwesomeIcon icon={faQrcode} />\n        </button>\n        <button id=\"boardBtn\" className=\"im-chat-control-btn\">\n          <FontAwesomeIcon icon={faMoneyBillTransfer} />\n        </button>\n        <button id=\"recordBtn\" className=\"im-chat-control-btn\">\n          <FontAwesomeIcon icon={faRecordVinyl} />\n        </button>\n      </div>\n    );\n  };\n\n  useEffect(() => {\n    if (!socket) return;\n\n    // 初始化WebRTC服务\n    webrtcRef.current = new WebRTCService(socket);\n    webrtcRef.current.onRemoteStream = (stream) => {\n      if (remoteVideoref.current) {\n        remoteVideoref.current.srcObject = stream;\n      }\n    };\n\n    const handleVideoInviteSent = (event) => {\n      const data = event.detail;\n      console.log(\"Video invite sent successfully:\", data);\n      if (data.success) {\n        setShowVideoInvite(true);\n      }\n    };\n\n    const handleVideoInviteFailed = (event) => {\n      const data = event.detail;\n      console.log(\"Video invite failed:\", data);\n      alert(`无法发起视频通话：${data.error}`);\n      setShowVideoInvite(false);\n      stopVideoCall();\n    };\n\n    const handleVideoAccept = async (event) => {\n      const data = event.detail;\n      console.log(\"Video call accepted, starting local stream...\");\n      try {\n        // 启动本地视频流\n        await startVideoCall(true);\n        console.log(\"Local stream started, creating offer...\");\n\n        // 创建并发送 offer\n        const offer = await webrtcRef.current.createOffer();\n        console.log(\"Offer created:\", offer);\n        sendVideoOffer(data.from, offer);\n      } catch (error) {\n        console.error(\"Error in handleVideoAccept:\", error);\n        stopVideoCall();\n      }\n    };\n\n    const handleVideoReject = () => {\n      setShowVideoInvite(false);\n      stopVideoCall();\n    };\n\n    const handleVideoOffer = async (event) => {\n      const data = event.detail;\n      console.log(\"Received video offer:\", data);\n      try {\n        // 启动本地视频流\n        await startVideoCall(false);\n        console.log(\"Local stream started for receiver\");\n\n        // 处理 offer 并创建 answer\n        const answer = await webrtcRef.current.handleOffer(\n          data.offer,\n          data.from\n        );\n        console.log(\"Created answer:\", answer);\n\n        // 发送 answer\n        sendVideoAnswer(data.from, answer);\n      } catch (error) {\n        console.error(\"Error in handleVideoOffer:\", error);\n        stopVideoCall();\n      }\n    };\n\n    const handleVideoAnswer = async (event) => {\n      const data = event.detail;\n      try {\n        await webrtcRef.current.handleAnswer(data.answer);\n      } catch (error) {\n        console.error(\"Error handling video answer:\", error);\n      }\n    };\n\n    const handleIceCandidate = async (event) => {\n      const data = event.detail;\n      try {\n        await webrtcRef.current.handleIceCandidate(data.candidate);\n      } catch (error) {\n        console.error(\"Error handling ICE candidate:\", error);\n      }\n    };\n\n    const handleVideoEnd = () => {\n      stopVideoCall();\n    };\n\n    window.addEventListener(\"video_invite_sent\", handleVideoInviteSent);\n    window.addEventListener(\"video_invite_failed\", handleVideoInviteFailed);\n    window.addEventListener(\"video_accept\", handleVideoAccept);\n    window.addEventListener(\"video_reject\", handleVideoReject);\n    window.addEventListener(\"video_offer\", handleVideoOffer);\n    window.addEventListener(\"video_answer\", handleVideoAnswer);\n    window.addEventListener(\"ice_candidate\", handleIceCandidate);\n    window.addEventListener(\"video_end\", handleVideoEnd);\n\n    return () => {\n      window.removeEventListener(\"video_invite_sent\", handleVideoInviteSent);\n      window.removeEventListener(\n        \"video_invite_failed\",\n        handleVideoInviteFailed\n      );\n      window.removeEventListener(\"video_accept\", handleVideoAccept);\n      window.removeEventListener(\"video_reject\", handleVideoReject);\n      window.removeEventListener(\"video_offer\", handleVideoOffer);\n      window.removeEventListener(\"video_answer\", handleVideoAnswer);\n      window.removeEventListener(\"ice_candidate\", handleIceCandidate);\n      window.removeEventListener(\"video_end\", handleVideoEnd);\n      stopVideoCall();\n    };\n  }, [socket, currentChatUser]);\n\n  const startVideoCall = async (isInitiator) => {\n    try {\n      console.log(\n        \"Starting video call as\",\n        isInitiator ? \"initiator\" : \"receiver\"\n      );\n\n      // 切换到视频模式\n      setMode(2);\n      console.log(\"Switched to video mode\");\n\n      // 等待一下确保视频元素已经渲染\n      await new Promise((resolve) => setTimeout(resolve, 100));\n\n      // 启动本地视频流\n      await webrtcRef.current.startLocalStream();\n      console.log(\"Local stream started\");\n\n      // 设置本地视频显示\n      if (localVideoref.current) {\n        localVideoref.current.srcObject = webrtcRef.current.localStream;\n        console.log(\"Local video element set up\");\n      } else {\n        console.error(\"Local video element not found\");\n        console.log(\"localVideoref:\", localVideoref);\n      }\n\n      // 创建对等连接\n      await webrtcRef.current.createPeerConnection();\n      console.log(\"Peer connection created\");\n    } catch (error) {\n      console.error(\"Error in startVideoCall:\", error);\n      stopVideoCall();\n      throw error;\n    }\n  };\n\n  const stopVideoCall = () => {\n    console.log(\"开始停止视频通话...\");\n\n    // 立即切换到文字模式，确保UI响应迅速\n    setMode(1);\n\n    const forceStopStream = async (stream) => {\n      if (!stream) return;\n      try {\n        const tracks = stream.getTracks();\n        console.log(`停止 ${tracks.length} 个媒体轨道`);\n        \n        // 先禁用所有轨道\n        tracks.forEach(track => {\n          track.enabled = false;\n          track.muted = true;\n        });\n\n        // 等待一小段时间确保禁用生效\n        await new Promise(resolve => setTimeout(resolve, 10));\n\n        // 然后停止所有轨道\n        tracks.forEach(track => {\n          try {\n            track.stop();\n            stream.removeTrack(track);\n            console.log(`成功停止并移除轨道: ${track.kind}`);\n          } catch (err) {\n            console.error(`停止轨道失败: ${track.kind}`, err);\n          }\n        });\n      } catch (err) {\n        console.error(\"停止媒体流失败:\", err);\n      }\n    };\n\n    const cleanup = async () => {\n      try {\n        // 1. 先关闭 WebRTC 连接\n        if (webrtcRef.current) {\n          console.log(\"关闭 WebRTC 连接\");\n          webrtcRef.current.closeConnection();\n          \n          if (webrtcRef.current.localStream) {\n            console.log(\"停止 WebRTC 本地流\");\n            await forceStopStream(webrtcRef.current.localStream);\n            webrtcRef.current.localStream = null;\n          }\n        }\n\n        // 2. 停止并清理本地视频\n        if (localVideoref.current && localVideoref.current.srcObject) {\n          console.log(\"清理本地视频元素\");\n          await forceStopStream(localVideoref.current.srcObject);\n          localVideoref.current.srcObject = null;\n          localVideoref.current.load(); // 强制重载视频元素\n        }\n\n        // 3. 停止并清理远程视频\n        if (remoteVideoref.current && remoteVideoref.current.srcObject) {\n          console.log(\"清理远程视频元素\");\n          await forceStopStream(remoteVideoref.current.srcObject);\n          remoteVideoref.current.srcObject = null;\n          remoteVideoref.current.load(); // 强制重载视频元素\n        }\n\n        // 4. 强制释放所有媒体设备\n        const devices = await navigator.mediaDevices.enumerateDevices();\n        const videoDevices = devices.filter(device => device.kind === 'videoinput');\n        \n        for (const device of videoDevices) {\n          try {\n            const stream = await navigator.mediaDevices.getUserMedia({\n              video: { deviceId: device.deviceId },\n              audio: false\n            });\n            await forceStopStream(stream);\n          } catch (err) {\n            console.log(`设备 ${device.label} 已释放`);\n          }\n        }\n\n        // 5. 请求垃圾回收\n        if (window.gc) {\n          window.gc();\n        }\n\n        console.log(\"视频通话停止完成\");\n      } catch (err) {\n        console.error(\"清理过程中出错:\", err);\n      }\n    };\n\n    // 执行清理\n    cleanup();\n  };\n\n  const handleVideoButtonClick = async () => {\n    try {\n      if (!currentChatUser) {\n        console.error(\"No chat user selected\");\n        return;\n      }\n\n      if (mode === 1) {\n        // 发送视频通话邀请\n        sendVideoInvite(currentChatUser.uid);\n        // 预启动本地视频\n        try {\n          await webrtcRef.current.startLocalStream();\n          if (localVideoref.current) {\n            localVideoref.current.srcObject = webrtcRef.current.localStream;\n          }\n        } catch (error) {\n          console.error(\"Error starting local stream:\", error);\n        }\n      } else {\n        // 结束视频通话\n        sendVideoEnd(currentChatUser.uid);\n        stopVideoCall();\n      }\n    } catch (error) {\n      console.error(\"Error in handleVideoButtonClick:\", error);\n    }\n  };\n  // 视频通话接受\n  const handleAcceptCall = async () => {\n    if (!incomingCall) return;\n    sendVideoAccept(incomingCall.from);\n    dispatch(setIncomingCall(null));\n  };\n\n  // 视频通话拒绝\n  const handleRejectCall = () => {\n    if (!incomingCall) return;\n    sendVideoReject(incomingCall.from);\n    dispatch(setIncomingCall(null));\n  };\n\n  // 发送消息\n  const handleSendMessage = () => {\n    if (!message.trim()) return;\n\n    if (currentChatUser && currentChatUser.uid) {\n      sendMessage(currentChatUser.uid, message.trim());\n      setMessage(\"\");\n    } else {\n      console.error(\"No valid chat user selected\");\n    }\n  };\n\n  // 接收消息\n  useEffect(() => {\n    const handleMessage = (event) => {\n      const msg = event.detail;\n      // 只显示当前聊天用户的消息\n      if (\n        currentChatUser &&\n        (msg.from?.id === currentChatUser.uid ||\n          msg.account?.id === currentChatUser.uid)\n      ) {\n        setMessages((prev) => [...prev, msg]);\n        scrollToBottom();\n      }\n    };\n\n    if (socket) {\n      window.addEventListener(\"im_message\", handleMessage);\n\n      socket.on(\"history_messages\", (messages) => {\n        console.log(\"Received history messages:\", messages);\n        // 过滤消息，只显示与当前聊天用户相关的消息\n        const filteredMessages = messages.filter(\n          (msg) =>\n            currentChatUser &&\n            (msg.from?.id === currentChatUser.uid ||\n              msg.account?.id === currentChatUser.uid)\n        );\n        setMessages(filteredMessages);\n        scrollToBottom();\n      });\n    }\n    return () => {\n      window.removeEventListener(\"im_message\", handleMessage);\n      if (socket) {\n        socket.off(\"history_messages\");\n      }\n    };\n  }, [socket, currentChatUser]);\n\n  // 当打开聊天窗口时，加载历史消息\n  useEffect(() => {\n    if (socket && currentChatUser) {\n      // 清除未读消息计数\n      dispatch(clearUnreadMessages({ uid: currentChatUser.uid }));\n\n      // 请求历史消息\n      getHistoryMessages(currentChatUser.uid);\n\n      // 清空当前消息列表\n      setMessages([]);\n\n      // 更新全局变量，用于未读消息计数判断\n      window.currentChatUser = currentChatUser;\n    }\n\n    // 组件卸载时清除全局变量\n    return () => {\n      window.currentChatUser = null;\n    };\n  }, [socket, currentChatUser, dispatch]);\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  const showLocalVideo = () => {\n    return hideLocalVideo ? null : (\n      <ImDialog\n        padding={\"0px\"}\n        axis={\"both\"}\n        style={{\n          position: \"absolute\", // 添加绝对定位\n          top: \"20px\", // 距离顶部20px\n          right: \"20px\", // 距离右侧20px\n          width: \"150px\",\n          height: \"150px\",\n          minWidth: \"100px\",\n          minHeight: \"100px\",\n          backgroundColor: \"#000\",\n          borderRadius: \"8px\",\n          overflow: \"hidden\",\n          boxShadow: \"0 4px 8px rgba(0,0,0,0.3)\",\n          resize: \"both\",\n          zIndex: 1000,\n        }}\n        // bounds=\".im-frame\" // 限制拖拽范围在视频聊天窗口内\n      >\n        <video\n          id=\"localVideo\"\n          ref={localVideoref}\n          autoPlay\n          muted\n          playsInline\n          onDoubleClick={swapVideoStreams}\n        ></video>\n        <button\n          className=\"btn-close\"\n          onClick={() => {\n            // 发送结束视频信号给对方\n            if (currentChatUser && currentChatUser.uid) {\n              sendVideoEnd(currentChatUser.uid);\n            }\n            // 本地关闭视频\n            setHideLocalVideo(true);\n            stopVideoCall();\n            setMode(1); // 切换回文字聊天模式\n          }}\n        >\n          <FontAwesomeIcon icon={faXmark} />\n        </button>\n      </ImDialog>\n    );\n  };\n\n  // 交换视频流\n  const swapVideoStreams = () => {\n    if (!localVideoref.current || !remoteVideoref.current) return;\n\n    const localStream = localVideoref.current.srcObject;\n    const remoteStream = remoteVideoref.current.srcObject;\n\n    localVideoref.current.srcObject = remoteStream;\n    remoteVideoref.current.srcObject = localStream;\n  };\n\n  const videoMode = () => {\n    console.log(\"Rendering video mode, localVideoref:\", localVideoref.current);\n    return (\n      <div className=\"im-frame\">\n        <div style={{ position: \"relative\", width: \"100%\", height: \"100%\" }}>\n          {/* 远程视频（大窗口） */}\n          <video\n            id=\"remoteVideo\"\n            ref={remoteVideoref}\n            autoPlay\n            playsInline\n            style={{\n              width: \"100%\",\n              height: \"100%\",\n              objectFit: \"cover\",\n              backgroundColor: \"#000\",\n            }}\n            onClick={() => setHideControl(!hideControl)}\n          />\n          {/* 本地视频（小窗口） */}\n          {!hideLocalVideo && showLocalVideo()}\n          {showControl()}\n        </div>\n      </div>\n    );\n  };\n\n  const textMode = () => {\n    return (\n      <div className=\"im-frame\">\n        <div\n          className=\"im-chat\"\n          style={{ flex: 1, padding: \"10px\", overflow: \"auto\" }}\n        >\n          {messages.map((msg, index) => {\n            const currentUid = parseInt(\n              new URLSearchParams(window.location.search).get(\"uId\")\n            );\n            const isMe = msg.from?.id === currentUid;\n            console.log(\n              \"Message sender:\",\n              msg.from?.id,\n              \"Current user:\",\n              currentUid,\n              \"isMe:\",\n              isMe\n            );\n            const time = new Date(msg.timestamp).toLocaleString();\n\n            if (\n              index === 0 ||\n              new Date(msg.timestamp).getDate() !==\n                new Date(messages[index - 1].timestamp).getDate()\n            ) {\n              return (\n                <React.Fragment key={index}>\n                  <div className=\"im-chat-time\">{time}</div>\n                  <div className={isMe ? \"me-chat-panel\" : \"you-chat-panel\"}>\n                    {!isMe && (\n                      <button className=\"im-chat-control-btn\">\n                        <FontAwesomeIcon icon={faUser} />\n                      </button>\n                    )}\n                    <div className={isMe ? \"me-chat\" : \"you-chat\"}>\n                      {msg.content}\n                    </div>\n                    {isMe && (\n                      <button className=\"im-chat-control-btn\">\n                        <FontAwesomeIcon icon={faUser} />\n                      </button>\n                    )}\n                  </div>\n                </React.Fragment>\n              );\n            }\n\n            return (\n              <div\n                key={index}\n                className={isMe ? \"me-chat-panel\" : \"you-chat-panel\"}\n              >\n                {!isMe && (\n                  <button className=\"im-chat-control-btn\">\n                    <FontAwesomeIcon icon={faUser} />\n                  </button>\n                )}\n                <div className={isMe ? \"me-chat\" : \"you-chat\"}>\n                  {msg.content}\n                </div>\n                {isMe && (\n                  <button className=\"im-chat-control-btn\">\n                    <FontAwesomeIcon icon={faUser} />\n                  </button>\n                )}\n              </div>\n            );\n          })}\n          <div ref={messagesEndRef} />\n        </div>\n        <div className=\"im-chat\">\n          <div style={{ padding: \"5px\" }}>\n            <button\n              className=\"im-header-button\"\n              onClick={() => dispatch(togglerChat(currentChatUser))}\n              onTouchEnd={() => dispatch(togglerChat(currentChatUser))}\n            >\n              <FontAwesomeIcon icon={faSmile} />\n            </button>\n            <button\n              className=\"im-header-button\"\n              onClick={() => dispatch(togglerChat(currentChatUser))}\n              onTouchEnd={() => dispatch(togglerChat(currentChatUser))}\n            >\n              <FontAwesomeIcon icon={faFile} />\n            </button>\n            <button\n              className=\"im-header-button\"\n              onClick={() => dispatch(togglerChat(currentChatUser))}\n              onTouchEnd={() => dispatch(togglerChat(currentChatUser))}\n            >\n              <FontAwesomeIcon icon={faScissors} />\n            </button>\n            <button\n              className=\"im-header-button\"\n              onClick={() => dispatch(togglerChat())}\n              onTouchEnd={() => dispatch(togglerChat())}\n            >\n              <FontAwesomeIcon icon={faPhone} />\n            </button>\n            <button\n              className=\"im-header-button\"\n              onClick={() => {\n                console.log(\"Video button clicked\");\n                console.log(\"Current chat user:\", currentChatUser);\n                handleVideoButtonClick();\n              }}\n              onTouchEnd={handleVideoButtonClick}\n            >\n              <FontAwesomeIcon icon={faVideo} />\n            </button>\n            <button\n              className=\"im-header-button\"\n              onClick={handleSendMessage}\n              onTouchEnd={handleSendMessage}\n            >\n              <FontAwesomeIcon icon={faPaperPlane} />\n            </button>\n          </div>\n          <div>\n            <textarea\n              className=\"im-input\"\n              type=\"text\"\n              placeholder=\"在此输入文本消息，按回车键发送\"\n              value={message}\n              onChange={(e) => setMessage(e.target.value)}\n              onKeyPress={(e) => {\n                if (e.key === \"Enter\" && !e.shiftKey) {\n                  e.preventDefault();\n                  handleSendMessage();\n                }\n              }}\n              required\n            />\n          </div>\n        </div>\n      </div>\n    );\n  };\n\n  return (\n    <FullScreen handle={handle} onChange={onChange}>\n      <ImDialog\n        point={{ x: full ? 0 : bounds.left + 230, y: full ? 0 : bounds.top }}\n        bounds={bounds}\n        title={\n          <span className=\"im-header-title\">\n            {currentChatUser?.name || \"聊天\"}\n          </span>\n        }\n        buttons={\n          <div>\n            <button\n              className=\"im-header-button\"\n              onClick={() => {\n                if (!full) {\n                  setFull(true);\n                  handle.enter();\n                } else {\n                  setFull(false);\n                  handle.exit();\n                }\n              }}\n              onTouchEnd={handle.enter}\n            >\n              <FontAwesomeIcon icon={faCompress} />\n            </button>\n            <button\n              className=\"im-header-button\"\n              onClick={() => dispatch(togglerChat(null))}\n              onTouchEnd={() => dispatch(togglerChat(null))}\n            >\n              <FontAwesomeIcon icon={faXmark} />\n            </button>\n          </div>\n        }\n        style={{\n          width: full ? \"100vw\" : 500,\n          height: full ? \"100vh\" : 500,\n          resize: full ? \"none\" : \"both\",\n          minWidth: 400,\n          minHeight: 400,\n        }}\n        axis={full ? \"none\" : \"both\"}\n        cancel={\".im-frame\"}\n      >\n        {mode === 1 ? textMode() : videoMode()}\n      </ImDialog>\n    </FullScreen>\n  );\n}\n\nexport default ImChat;\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}