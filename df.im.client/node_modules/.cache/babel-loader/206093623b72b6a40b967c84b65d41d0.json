{"ast":null,"code":"import _regeneratorRuntime from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import{createAsyncThunk,createSlice,configureStore,combineReducers}from\"@reduxjs/toolkit\";import{getUserList}from\"./imApi\";var initialState={showMain:false,showSetting:false,showChat:false,showHelp:false,size:{left:0,top:0,right:window.innerWidth-20-40,bottom:window.innerHeight-20-40},status:\"idle\",zIndex:9999,users:[],currentChatUser:null,// 添加当前聊天用户信息\nonlineUsers:{},// 在线用户状态\nunreadMessages:{}// 未读消息计数\n};export var getUsers=createAsyncThunk(\"imReducer/getUsers\",/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(params,_ref){var dispatch,urlParams,uid,response;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:dispatch=_ref.dispatch;urlParams=new URLSearchParams(window.location.search);uid=urlParams.get(\"uId\");console.log(\"Getting users for uid:\",uid);_context.next=6;return getUserList(parseInt(uid));case 6:response=_context.sent;return _context.abrupt(\"return\",response.data);case 8:case\"end\":return _context.stop();}}},_callee);}));return function(_x,_x2){return _ref2.apply(this,arguments);};}());var imSlice=createSlice({name:\"imReducer\",// 生成的action名中会包含此前缀\ninitialState:initialState,reducers:{togglerMain:function togglerMain(state){// action name : 'imReducer/togglerMain'\nstate.showMain=!state.showMain;},resize:function resize(state){state.size.right=window.innerWidth-20;state.size.bottom=window.innerHeight-20;},togglerSetting:function togglerSetting(state){state.showSetting=!state.showSetting;},togglerChat:function togglerChat(state,action){if(action.payload){// 如果提供了用户信息，说明是要打开或切换聊天\nstate.showChat=true;state.currentChatUser=action.payload;}else{// 如果没有提供用户信息，说明是要关闭聊天窗口\nstate.showChat=false;state.currentChatUser=null;}},togglerHelp:function togglerHelp(state){state.showHelp=!state.showHelp;},incrementzIndex:function incrementzIndex(state){state.zIndex+=1;},updateUserStatus:function updateUserStatus(state,action){state.onlineUsers[action.payload.uid]=action.payload.online;},addUnreadMessage:function addUnreadMessage(state,action){var fromUid=action.payload.fromUid;if(!state.unreadMessages[fromUid]){state.unreadMessages[fromUid]=0;}state.unreadMessages[fromUid]++;},clearUnreadMessages:function clearUnreadMessages(state,action){var uid=action.payload.uid;state.unreadMessages[uid]=0;}},extraReducers:function extraReducers(builder){builder.addCase(getUsers.pending,function(state){state.status=\"loading\";}).addCase(getUsers.fulfilled,function(state,action){state.status=\"successful\";state.users=Array.isArray(action.payload)?action.payload:[];}).addCase(getUsers.rejected,function(state,action){state.status=\"failed\";console.error(\"Failed to get users:\",action.error.message);state.users=[];// 确保users始终是数组\n});}});// imSlice actions ************************************************\nvar _imSlice$actions=imSlice.actions,togglerMain=_imSlice$actions.togglerMain,resize=_imSlice$actions.resize,togglerSetting=_imSlice$actions.togglerSetting,togglerChat=_imSlice$actions.togglerChat,togglerHelp=_imSlice$actions.togglerHelp,incrementzIndex=_imSlice$actions.incrementzIndex,updateUserStatus=_imSlice$actions.updateUserStatus,addUnreadMessage=_imSlice$actions.addUnreadMessage,clearUnreadMessages=_imSlice$actions.clearUnreadMessages;// imReducer states ************************************************\nexport{togglerMain,resize,togglerSetting,togglerChat,togglerHelp,incrementzIndex,updateUserStatus,addUnreadMessage,clearUnreadMessages};export var showMain=function showMain(state){return state.imReducer.showMain;};export var showSetting=function showSetting(state){return state.imReducer.showSetting;};export var showChat=function showChat(state){return state.imReducer.showChat;};export var showHelp=function showHelp(state){return state.imReducer.showHelp;};export var zIndex=function zIndex(state){return state.imReducer.zIndex;};// imStore states ************************************************\nexport var imStore=configureStore({reducer:{imReducer:imSlice.reducer}});// imStore.subscribe(() => console.log(imStore.getState()));","map":{"version":3,"names":["createAsyncThunk","createSlice","configureStore","combineReducers","getUserList","initialState","showMain","showSetting","showChat","showHelp","size","left","top","right","window","innerWidth","bottom","innerHeight","status","zIndex","users","currentChatUser","onlineUsers","unreadMessages","getUsers","params","dispatch","urlParams","URLSearchParams","location","search","uid","get","console","log","parseInt","response","data","imSlice","name","reducers","togglerMain","state","resize","togglerSetting","togglerChat","action","payload","togglerHelp","incrementzIndex","updateUserStatus","online","addUnreadMessage","fromUid","clearUnreadMessages","extraReducers","builder","addCase","pending","fulfilled","Array","isArray","rejected","error","message","actions","imReducer","imStore","reducer"],"sources":["/Users/feng/Work/Project/df/df.im/df.im.client/src/im/imStore.js"],"sourcesContent":["import {\n  createAsyncThunk,\n  createSlice,\n  configureStore,\n  combineReducers,\n} from \"@reduxjs/toolkit\";\nimport { getUserList } from \"./imApi\";\n\nconst initialState = {\n  showMain: false,\n  showSetting: false,\n  showChat: false,\n  showHelp: false,\n  size: {\n    left: 0,\n    top: 0,\n    right: window.innerWidth - 20 - 40,\n    bottom: window.innerHeight - 20 - 40,\n  },\n  status: \"idle\",\n  zIndex: 9999,\n  users: [],\n  currentChatUser: null, // 添加当前聊天用户信息\n  onlineUsers: {}, // 在线用户状态\n  unreadMessages: {}, // 未读消息计数\n};\n\nexport const getUsers = createAsyncThunk(\n  \"imReducer/getUsers\",\n  async (params, { dispatch }) => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const uid = urlParams.get(\"uId\");\n    console.log(\"Getting users for uid:\", uid);\n    const response = await getUserList(parseInt(uid));\n    return response.data;\n  }\n);\n\nconst imSlice = createSlice({\n  name: \"imReducer\", // 生成的action名中会包含此前缀\n  initialState,\n  reducers: {\n    togglerMain: (state) => {\n      // action name : 'imReducer/togglerMain'\n      state.showMain = !state.showMain;\n    },\n    resize: (state) => {\n      state.size.right = window.innerWidth - 20;\n      state.size.bottom = window.innerHeight - 20;\n    },\n    togglerSetting: (state) => {\n      state.showSetting = !state.showSetting;\n    },\n    togglerChat: (state, action) => {\n      if (action.payload) {\n        // 如果提供了用户信息，说明是要打开或切换聊天\n        state.showChat = true;\n        state.currentChatUser = action.payload;\n      } else {\n        // 如果没有提供用户信息，说明是要关闭聊天窗口\n        state.showChat = false;\n        state.currentChatUser = null;\n      }\n    },\n    togglerHelp: (state) => {\n      state.showHelp = !state.showHelp;\n    },\n    incrementzIndex: (state) => {\n      state.zIndex += 1;\n    },\n    updateUserStatus: (state, action) => {\n      state.onlineUsers[action.payload.uid] = action.payload.online;\n    },\n    addUnreadMessage: (state, action) => {\n      const { fromUid } = action.payload;\n      if (!state.unreadMessages[fromUid]) {\n        state.unreadMessages[fromUid] = 0;\n      }\n      state.unreadMessages[fromUid]++;\n    },\n    clearUnreadMessages: (state, action) => {\n      const { uid } = action.payload;\n      state.unreadMessages[uid] = 0;\n    },\n  },\n  extraReducers: (builder) => {\n    builder\n      .addCase(getUsers.pending, (state) => {\n        state.status = \"loading\";\n      })\n      .addCase(getUsers.fulfilled, (state, action) => {\n        state.status = \"successful\";\n        state.users = Array.isArray(action.payload) ? action.payload : [];\n      })\n      .addCase(getUsers.rejected, (state, action) => {\n        state.status = \"failed\";\n        console.error(\"Failed to get users:\", action.error.message);\n        state.users = []; // 确保users始终是数组\n      });\n  },\n});\n\n// imSlice actions ************************************************\nexport const {\n  togglerMain,\n  resize,\n  togglerSetting,\n  togglerChat,\n  togglerHelp,\n  incrementzIndex,\n  updateUserStatus,\n  addUnreadMessage,\n  clearUnreadMessages,\n} = imSlice.actions;\n\n// imReducer states ************************************************\nexport const showMain = (state) => state.imReducer.showMain;\nexport const showSetting = (state) => state.imReducer.showSetting;\nexport const showChat = (state) => state.imReducer.showChat;\nexport const showHelp = (state) => state.imReducer.showHelp;\nexport const zIndex = (state) => state.imReducer.zIndex;\n\n// imStore states ************************************************\nexport const imStore = configureStore({\n  reducer: {\n    imReducer: imSlice.reducer,\n  },\n});\n\n// imStore.subscribe(() => console.log(imStore.getState()));\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}