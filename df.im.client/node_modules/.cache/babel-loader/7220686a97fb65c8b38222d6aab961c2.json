{"ast":null,"code":"import _regeneratorRuntime from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _classCallCheck from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/Users/feng/Work/Project/df/df.im/df.im.client/node_modules/@babel/runtime/helpers/esm/createClass.js\";var WebRTCService=/*#__PURE__*/function(){function WebRTCService(socket){_classCallCheck(this,WebRTCService);this.socket=socket;this.peerConnection=null;this.localStream=null;this.remoteStream=null;this.configuration={iceServers:[{urls:\"stun:stun.l.google.com:19302\"},{urls:\"stun:stun1.l.google.com:19302\"}]};}_createClass(WebRTCService,[{key:\"startLocalStream\",value:function(){var _startLocalStream=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(){return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return navigator.mediaDevices.getUserMedia({video:true,audio:true});case 3:this.localStream=_context.sent;return _context.abrupt(\"return\",this.localStream);case 7:_context.prev=7;_context.t0=_context[\"catch\"](0);console.error(\"Error accessing media devices:\",_context.t0);throw _context.t0;case 11:case\"end\":return _context.stop();}}},_callee,this,[[0,7]]);}));function startLocalStream(){return _startLocalStream.apply(this,arguments);}return startLocalStream;}()},{key:\"createPeerConnection\",value:function(){var _createPeerConnection=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(){var _this=this;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;this.peerConnection=new RTCPeerConnection(this.configuration);// 添加本地流\nthis.localStream.getTracks().forEach(function(track){_this.peerConnection.addTrack(track,_this.localStream);});// 处理远程流\nthis.peerConnection.ontrack=function(event){_this.remoteStream=event.streams[0];if(_this.onRemoteStream){_this.onRemoteStream(_this.remoteStream);}};// 处理ICE候选\nthis.peerConnection.onicecandidate=function(event){if(event.candidate){_this.socket.emit(\"ice-candidate\",{candidate:event.candidate,to:_this.remoteUserId});}};return _context2.abrupt(\"return\",this.peerConnection);case 8:_context2.prev=8;_context2.t0=_context2[\"catch\"](0);console.error(\"Error creating peer connection:\",_context2.t0);throw _context2.t0;case 12:case\"end\":return _context2.stop();}}},_callee2,this,[[0,8]]);}));function createPeerConnection(){return _createPeerConnection.apply(this,arguments);}return createPeerConnection;}()},{key:\"createOffer\",value:function(){var _createOffer=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(){var offer;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;_context3.next=3;return this.peerConnection.createOffer();case 3:offer=_context3.sent;_context3.next=6;return this.peerConnection.setLocalDescription(offer);case 6:return _context3.abrupt(\"return\",offer);case 9:_context3.prev=9;_context3.t0=_context3[\"catch\"](0);console.error(\"Error creating offer:\",_context3.t0);throw _context3.t0;case 13:case\"end\":return _context3.stop();}}},_callee3,this,[[0,9]]);}));function createOffer(){return _createOffer.apply(this,arguments);}return createOffer;}()},{key:\"handleOffer\",value:function(){var _handleOffer=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(offer,fromUserId){var answer;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;this.remoteUserId=fromUserId;_context4.next=4;return this.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));case 4:_context4.next=6;return this.peerConnection.createAnswer();case 6:answer=_context4.sent;_context4.next=9;return this.peerConnection.setLocalDescription(answer);case 9:return _context4.abrupt(\"return\",answer);case 12:_context4.prev=12;_context4.t0=_context4[\"catch\"](0);console.error(\"Error handling offer:\",_context4.t0);throw _context4.t0;case 16:case\"end\":return _context4.stop();}}},_callee4,this,[[0,12]]);}));function handleOffer(_x,_x2){return _handleOffer.apply(this,arguments);}return handleOffer;}()},{key:\"handleAnswer\",value:function(){var _handleAnswer=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5(answer){return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.prev=0;_context5.next=3;return this.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));case 3:_context5.next=9;break;case 5:_context5.prev=5;_context5.t0=_context5[\"catch\"](0);console.error(\"Error handling answer:\",_context5.t0);throw _context5.t0;case 9:case\"end\":return _context5.stop();}}},_callee5,this,[[0,5]]);}));function handleAnswer(_x3){return _handleAnswer.apply(this,arguments);}return handleAnswer;}()},{key:\"handleIceCandidate\",value:function(){var _handleIceCandidate=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6(candidate){return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.prev=0;_context6.next=3;return this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));case 3:_context6.next=9;break;case 5:_context6.prev=5;_context6.t0=_context6[\"catch\"](0);console.error(\"Error handling ICE candidate:\",_context6.t0);throw _context6.t0;case 9:case\"end\":return _context6.stop();}}},_callee6,this,[[0,5]]);}));function handleIceCandidate(_x4){return _handleIceCandidate.apply(this,arguments);}return handleIceCandidate;}()},{key:\"closeConnection\",value:function closeConnection(){if(this.localStream){this.localStream.getTracks().forEach(function(track){return track.stop();});}if(this.peerConnection){this.peerConnection.close();}this.localStream=null;this.remoteStream=null;this.peerConnection=null;}}]);return WebRTCService;}();export default WebRTCService;","map":{"version":3,"names":["WebRTCService","socket","peerConnection","localStream","remoteStream","configuration","iceServers","urls","navigator","mediaDevices","getUserMedia","video","audio","console","error","RTCPeerConnection","getTracks","forEach","track","addTrack","ontrack","event","streams","onRemoteStream","onicecandidate","candidate","emit","to","remoteUserId","createOffer","offer","setLocalDescription","fromUserId","setRemoteDescription","RTCSessionDescription","createAnswer","answer","addIceCandidate","RTCIceCandidate","stop","close"],"sources":["/Users/feng/Work/Project/df/df.im/df.im.client/src/services/webrtc.js"],"sourcesContent":["class WebRTCService {\n  constructor(socket) {\n    this.socket = socket;\n    this.peerConnection = null;\n    this.localStream = null;\n    this.remoteStream = null;\n    this.configuration = {\n      iceServers: [\n        { urls: \"stun:stun.l.google.com:19302\" },\n        { urls: \"stun:stun1.l.google.com:19302\" },\n      ],\n    };\n  }\n\n  async startLocalStream() {\n    try {\n      this.localStream = await navigator.mediaDevices.getUserMedia({\n        video: true,\n        audio: true,\n      });\n      return this.localStream;\n    } catch (error) {\n      console.error(\"Error accessing media devices:\", error);\n      throw error;\n    }\n  }\n\n  async createPeerConnection() {\n    try {\n      this.peerConnection = new RTCPeerConnection(this.configuration);\n\n      // 添加本地流\n      this.localStream.getTracks().forEach((track) => {\n        this.peerConnection.addTrack(track, this.localStream);\n      });\n\n      // 处理远程流\n      this.peerConnection.ontrack = (event) => {\n        this.remoteStream = event.streams[0];\n        if (this.onRemoteStream) {\n          this.onRemoteStream(this.remoteStream);\n        }\n      };\n\n      // 处理ICE候选\n      this.peerConnection.onicecandidate = (event) => {\n        if (event.candidate) {\n          this.socket.emit(\"ice-candidate\", {\n            candidate: event.candidate,\n            to: this.remoteUserId,\n          });\n        }\n      };\n\n      return this.peerConnection;\n    } catch (error) {\n      console.error(\"Error creating peer connection:\", error);\n      throw error;\n    }\n  }\n\n  async createOffer() {\n    try {\n      const offer = await this.peerConnection.createOffer();\n      await this.peerConnection.setLocalDescription(offer);\n      return offer;\n    } catch (error) {\n      console.error(\"Error creating offer:\", error);\n      throw error;\n    }\n  }\n\n  async handleOffer(offer, fromUserId) {\n    try {\n      this.remoteUserId = fromUserId;\n      await this.peerConnection.setRemoteDescription(\n        new RTCSessionDescription(offer)\n      );\n      const answer = await this.peerConnection.createAnswer();\n      await this.peerConnection.setLocalDescription(answer);\n      return answer;\n    } catch (error) {\n      console.error(\"Error handling offer:\", error);\n      throw error;\n    }\n  }\n\n  async handleAnswer(answer) {\n    try {\n      await this.peerConnection.setRemoteDescription(\n        new RTCSessionDescription(answer)\n      );\n    } catch (error) {\n      console.error(\"Error handling answer:\", error);\n      throw error;\n    }\n  }\n\n  async handleIceCandidate(candidate) {\n    try {\n      await this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));\n    } catch (error) {\n      console.error(\"Error handling ICE candidate:\", error);\n      throw error;\n    }\n  }\n\n  closeConnection() {\n    if (this.localStream) {\n      this.localStream.getTracks().forEach((track) => track.stop());\n    }\n    if (this.peerConnection) {\n      this.peerConnection.close();\n    }\n    this.localStream = null;\n    this.remoteStream = null;\n    this.peerConnection = null;\n  }\n}\n\nexport default WebRTCService;\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}